name: Continuous Deployment

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set the release version
        run: echo "RELEASE_VERSION=${GITHUB_REF:11}" >> $GITHUB_ENV

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm file libfuse2

      - name: Build binary
        run: zig build -Dtarget=x86_64-linux -Doptimize=ReleaseSafe --summary all

      - name: Create tar.gz archive
        run: |
          cd zig-out/bin
          tar -czf mimg-x86_64-linux.tar.gz mimg
          mv mimg-x86_64-linux.tar.gz ../..

      - name: Build DEB package
        run: |
          cd packaging/linux
          ./build-deb.sh ../../zig-out/bin/mimg . ${RELEASE_VERSION#v}

      - name: Build RPM package
        run: |
          cd packaging/linux
          ./build-rpm.sh ../../zig-out/bin/mimg . ${RELEASE_VERSION#v}

      - name: Build AppImage
        run: |
          cd packaging/linux
          ./build-appimage.sh ../../zig-out/bin/mimg . ${RELEASE_VERSION#v}

      - name: Upload Linux artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          file: |
            mimg-x86_64-linux.tar.gz
            packaging/linux/*.deb
            packaging/linux/*.rpm
            packaging/linux/*.AppImage
          file_glob: true
          overwrite: true
          tag: ${{ github.ref }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Packages
    runs-on: macos-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set the release version
        run: echo "RELEASE_VERSION=${GITHUB_REF:11}" >> $GITHUB_ENV

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build binary
        run: zig build -Dtarget=x86_64-macos -Doptimize=ReleaseSafe --summary all

      - name: Create tar.gz archive
        run: |
          cd zig-out/bin
          tar -czf mimg-x86_64-macos.tar.gz mimg
          mv mimg-x86_64-macos.tar.gz ../..

      - name: Build DMG
        run: |
          cd packaging/macos
          ./build-dmg.sh ../../zig-out/bin/mimg . ${RELEASE_VERSION#v}

      - name: Build PKG
        run: |
          cd packaging/macos
          ./build-pkg.sh ../../zig-out/bin/mimg . ${RELEASE_VERSION#v}

      - name: Upload macOS artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          file: |
            mimg-x86_64-macos.tar.gz
            packaging/macos/*.dmg
            packaging/macos/*.pkg
          file_glob: true
          overwrite: true
          tag: ${{ github.ref }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Packages
    runs-on: windows-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set the release version
        shell: bash
        run: echo "RELEASE_VERSION=${GITHUB_REF:11}" >> $GITHUB_ENV

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install WiX Toolset
        run: |
          dotnet tool install --global wix
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build binary
        run: zig build -Dtarget=x86_64-windows -Doptimize=ReleaseSafe --summary all

      - name: Create zip archive
        shell: bash
        run: |
          cd zig-out/bin
          7z a ../../mimg-x86_64-windows.zip mimg.exe

      - name: Build MSI installer
        shell: bash
        run: |
          cd packaging/windows
          wix build mimg.wxs -d BinaryPath=../../zig-out/bin -out mimg-installer.msi

      - name: Upload Windows artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          file: |
            mimg-x86_64-windows.zip
            packaging/windows/*.msi
          file_glob: true
          overwrite: true
          tag: ${{ github.ref }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
