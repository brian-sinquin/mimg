name: Pull Request Validation

on:
  pull_request:
    branches: ['*']

permissions:
  contents: read

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/zig
          key: ${{ runner.os }}-zig-${{ hashFiles('**/build.zig.zon') }}
          restore-keys: |
            ${{ runner.os }}-zig-

      - name: Build
        run: zig build -Doptimize=ReleaseSafe

      - name: Run tests
        run: zig build test

  build-artifacts:
    name: Build Artifacts for Testing
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            name: Linux
          - os: macos-latest
            target: x86_64-macos
            name: macOS
          - os: windows-latest
            target: x86_64-windows
            name: Windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/zig
          key: ${{ runner.os }}-zig-${{ hashFiles('**/build.zig.zon') }}
          restore-keys: |
            ${{ runner.os }}-zig-

      - name: Build binary
        run: zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe --summary all

      # Linux artifacts
      - name: Install Linux packaging tools
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm file libfuse2

      - name: Create Linux tar.gz
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd zig-out/bin
          tar -czf mimg-${{ matrix.target }}.tar.gz mimg
          mv mimg-${{ matrix.target }}.tar.gz ../..

      - name: Build Linux DEB package
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd packaging/linux
          ./build-deb.sh ../../zig-out/bin/mimg . 0.0.0-pr

      - name: Build Linux RPM package
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd packaging/linux
          ./build-rpm.sh ../../zig-out/bin/mimg . 0.0.0-pr

      - name: Build Linux AppImage
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd packaging/linux
          ./build-appimage.sh ../../zig-out/bin/mimg . 0.0.0-pr

      - name: Upload Linux artifacts
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            mimg-${{ matrix.target }}.tar.gz
            packaging/linux/*.deb
            packaging/linux/*.rpm
            packaging/linux/*.AppImage
          retention-days: 30

      # macOS artifacts
      - name: Create macOS tar.gz
        if: matrix.os == 'macos-latest'
        run: |
          cd zig-out/bin
          tar -czf mimg-${{ matrix.target }}.tar.gz mimg
          mv mimg-${{ matrix.target }}.tar.gz ../..

      - name: Build macOS DMG
        if: matrix.os == 'macos-latest'
        run: |
          cd packaging/macos
          ./build-dmg.sh ../../zig-out/bin/mimg . 0.0.0-pr

      - name: Build macOS PKG
        if: matrix.os == 'macos-latest'
        run: |
          cd packaging/macos
          ./build-pkg.sh ../../zig-out/bin/mimg . 0.0.0-pr

      - name: Upload macOS artifacts
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: |
            mimg-${{ matrix.target }}.tar.gz
            packaging/macos/*.dmg
            packaging/macos/*.pkg
          retention-days: 30

      # Windows artifacts
      - name: Install WiX Toolset
        if: matrix.os == 'windows-latest'
        run: |
          dotnet tool install --global wix
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create Windows zip
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cd zig-out/bin
          7z a ../../mimg-${{ matrix.target }}.zip mimg.exe

      - name: Build Windows MSI installer
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cd packaging/windows
          wix build mimg.wxs -d BinaryPath=../../zig-out/bin -out mimg-installer.msi

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            mimg-${{ matrix.target }}.zip
            packaging/windows/*.msi
          retention-days: 30
